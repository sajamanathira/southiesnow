WORKING-STORAGE SECTION.
01  WS-LOC PIC X(03) VALUE SPACES.
    88  END-OF-DATA     VALUE 'XXX'.
    EXEC SQL
       INCLUDE EMPLOYEE
    END-EXEC
    EXEC SQL
       INCLUDE LOCATION
    END-EXEC
    EXEC SQL
       INCLUDE SQLCA
    END-EXEC
    EXEC SQL
       DECLARE EMP_CUR CURSOR FOR
       SELECT EMP_ID, EMP_NAME, EMP_TECH, EMP_EARN, EMP_DEDN
       FROM T01_EMPLOYEE_TABLE
       WHERE   EMP_LOC = :WS-LOC
    END-EXEC.
01  WS-TABLE-FLAG PIC X(01) VALUE 'N'.
    88  END-OF-ROWS         VALUE 'Y'.
PROCEDURE DIVISION.
MAIN-PARA.
    PERFORM INIT-PARA
    PERFORM PROCESS-PARA  UNTIL  END-OF-DATA
    PERFORM END-PARA
    STOP RUN.
INIT-PARA.
    OPEN OUTPUT REPORT-FILE.
    ACCEPT WS-LOC
    PERFORM GET-LOCATION
    PERFORM OPEN-CURSOR.
OPEN-CURSOR.
    EXEC SQL
        OPEN EMP_CUR
    END-EXEC.
GET-LOCATION.
    EXEC SQL
       SELECT LOC_NAME  INTO  :LOC-NAME
       FROM T01_LOCATION_TABLE
       WHERE LOC_ID = :WS-LOC
    END-EXEC.
    IF SQLCODE = ZERO
       MOVE LOC-NAME TO P-LOC-NAME
    ELSE
       MOVE SPACES   TO P-LOC-NAME
    END-IF.
PROCESS-PARA.
    PERFORM PROCESS-LOCATION  UNTIL  END-OF-ROWS
    MOVE 'N' TO WS-TABLE-FLAG
    ACCEPT WS-LOC
    IF END-OF-DATA
       DISPLAY 'END OF DATA, BYE, BYE!!'
    ELSE
       PERFORM GET-LOCATION
       PERFORM OPEN-CURSOR
    END-IF.
PROCESS-LOCATION.
    PERFORM FETCH-PARA.
    EVALUATE SQLCODE
       WHEN ZERO
          PERFORM MOVE-PARA
       WHEN 100
          MOVE 'Y' TO WS-TABLE-FLAG
          PERFORM CLOSE-CURSOR
       WHEN OTHER
          DISPLAY 'UNKNOWN ERROR'
    END-EVALUATE.
FETCH-PARA.
    EXEC SQL
       FETCH EMP_CUR INTO
       :EMP-ID, :EMP-NAME, :EMP-TECH, :EMP-EARN, :EMP-DEDN
    END-EXEC.
MOVE-PARA.
    Move Employee Details to DETAIL-LINE & Print it.
CLOSE-PARA.
    EXEC SQL
       CLOSE EMP_CUR
    END-EXEC.
